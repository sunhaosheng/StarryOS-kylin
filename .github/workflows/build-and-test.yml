name: Build and Test (Yocto)

on:
  push:
    branches:
      - change-workflow
  pull_request:
    branches:
      - change-workflow

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: yocto-builder:latest  # 使用自定义镜像（已预装 clang）
  HOST_WORKSPACE: /home/yean/code/starryos-workspace

jobs:
  build-and-test:
    runs-on: [self-hosted, yean-jiaolong]
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build and Test in Docker
        run: |
          # 在宿主机本地磁盘创建临时工作区（支持硬链接）
          BUILD_DIR=${{ env.HOST_WORKSPACE }}/ci-builds/${{ github.run_id }}
          mkdir -p $BUILD_DIR/workspace/build/conf
          chmod -R 777 $BUILD_DIR
          
          # 复制配置文件到临时目录（不修改宿主机原文件）
          cp ${{ env.HOST_WORKSPACE }}/build/conf/bblayers.conf $BUILD_DIR/workspace/build/conf/
          cp ${{ env.HOST_WORKSPACE }}/build/conf/local.conf $BUILD_DIR/workspace/build/conf/
          
          docker run --rm \
            --user root \
            --privileged \
            -v ${{ github.workspace }}:/source:ro \
            -v ${{ env.HOST_WORKSPACE }}/poky:/host-workspace/poky:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-starry:/host-workspace/meta-starry:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-openembedded:/host-workspace/meta-openembedded:ro \
            -v ${{ env.HOST_WORKSPACE }}/StarryOS:/host-workspace/StarryOS:ro \
            -v $BUILD_DIR:/build \
            -v ${{ env.HOST_WORKSPACE }}/build/sstate-cache:/build/workspace/build/sstate-cache \
            -v ${{ env.HOST_WORKSPACE }}/build/downloads:/build/workspace/build/downloads \
            -e HOST_PATH=${{ env.HOST_WORKSPACE }} \
            -e http_proxy="http://10.41.113.211:7897" \
            -e https_proxy="http://10.41.113.211:7897" \
            --network host \
            ${{ env.DOCKER_IMAGE }} \
            bash -c '
              set -e
              
              echo "=== Setting up build environment ==="
              WORKSPACE=/build/workspace
              mkdir -p $WORKSPACE
              
              # 符号链接共享的 Yocto 组件（只读）
              ln -sfn /host-workspace/poky $WORKSPACE/poky
              ln -sfn /host-workspace/meta-starry $WORKSPACE/meta-starry
              ln -sfn /host-workspace/meta-openembedded $WORKSPACE/meta-openembedded 2>/dev/null || true

              # build 目录结构已在宿主机准备好
              # 修复 bblayers.conf 中的路径（修改的是临时副本，不影响宿主机）
              sed -i "s|$HOST_PATH|$WORKSPACE|g" $WORKSPACE/build/conf/bblayers.conf
              
              # 显示修改后的配置用于调试
              echo "=== bblayers.conf ==="
              cat $WORKSPACE/build/conf/bblayers.conf
              echo "===================="
              
              # 同步 CI 触发的 StarryOS 代码
              echo "Copying StarryOS source code..."
              rm -rf $WORKSPACE/StarryOS
              mkdir -p $WORKSPACE/StarryOS
              cp -a /source/. $WORKSPACE/StarryOS/
              rm -rf $WORKSPACE/StarryOS/.git $WORKSPACE/StarryOS/target
              chmod -R a+rwX $WORKSPACE/StarryOS
              
              # 补齐依赖目录（来自宿主机 repo 工作区）
              if [ -d /host-workspace/StarryOS/arceos ]; then
                rm -rf $WORKSPACE/StarryOS/arceos
                cp -a /host-workspace/StarryOS/arceos $WORKSPACE/StarryOS/arceos
              fi
              if [ -d /host-workspace/StarryOS/local_crates ]; then
                rm -rf $WORKSPACE/StarryOS/local_crates
                cp -a /host-workspace/StarryOS/local_crates $WORKSPACE/StarryOS/local_crates
              fi
              
              # 配置 StarryOS 源码路径（EXTERNALSRC）
              echo "" >> $WORKSPACE/build/conf/local.conf
              echo "# CI 配置：指定 StarryOS 源码路径" >> $WORKSPACE/build/conf/local.conf
              echo "EXTERNALSRC:pn-starry = \"$WORKSPACE/StarryOS\"" >> $WORKSPACE/build/conf/local.conf
              echo "EXTERNALSRC_BUILD:pn-starry = \"$WORKSPACE/StarryOS\"" >> $WORKSPACE/build/conf/local.conf
              # build 目录已直接挂载，sstate-cache 和 downloads 在同一文件系统，无需额外配置路径

              echo "=== local.conf (tail) ==="
              tail -10 $WORKSPACE/build/conf/local.conf
              echo "========================="
              
              echo "=== Initializing Yocto environment ==="
              cd $WORKSPACE
              source poky/oe-init-build-env build
              
              echo "=== Debug for nondeterminism ==="
              bitbake starry -c do_configure -S none || true
              bitbake starry -c do_configure -S printdiff || true

              echo "=== Building StarryOS kernel ==="
              bitbake starry
              
              echo "=== Building minimal image ==="
              bitbake starry-minimal-image
              
              echo "=== Running QEMU test ==="
              timeout 120 bash -c "
                runqemu starry-minimal-image nographic slirp &
                QEMU_PID=\$!
                sleep 60
                if ps -p \$QEMU_PID > /dev/null; then
                  echo \"✔ QEMU boot test passed\"
                  kill \$QEMU_PID 2>/dev/null || true
                  exit 0
                else
                  echo \"❌ QEMU exited unexpectedly\"
                  exit 1
                fi
              " || {
                echo "❌ Test timed out or failed"
                exit 1
              }
              
              echo "=== All tests passed ==="
            '

      - name: Cleanup
        if: always()
        run: |
          # 清理可能残留的容器
          docker ps -aq --filter "ancestor=${{ env.DOCKER_IMAGE }}" | xargs -r docker rm -f || true
          
          # 清理临时构建目录
          BUILD_DIR=${{ env.HOST_WORKSPACE }}/ci-builds/${{ github.run_id }}
          if [ -d "$BUILD_DIR" ]; then
            echo "Cleaning up build directory: $BUILD_DIR"
            rm -rf "$BUILD_DIR"
          fi
