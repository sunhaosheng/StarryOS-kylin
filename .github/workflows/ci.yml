name: StarryOS CI (Yocto Image)

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  # 子仓库触发（arceos、arm-gic 等提 PR 时）
  repository_dispatch:
    types: [sub-repo-pr]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}-${{ github.event.client_payload.trigger_repo || 'starryos' }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: yocto-builder:latest
  HOST_WORKSPACE: /home/yean/code/starryos-workspace
  PROXY_HOST: 10.41.113.211:7897

jobs:
  build-and-test:
    runs-on: [self-hosted, yean-jiaolong]
    timeout-minutes: 120
    
    env:
      # 触发信息（用于子仓库 PR）
      TRIGGER_REPO: ${{ github.event.client_payload.trigger_repo || '' }}
      TRIGGER_SHA: ${{ github.event.client_payload.trigger_sha || '' }}
      TRIGGER_REF: ${{ github.event.client_payload.trigger_ref || '' }}
      
    steps:
      # ==================== 检出 PR 代码 ====================
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==================== Docker 构建和测试 ====================
      - name: Build and Test in Docker
        run: |
          docker run --rm \
            --user root \
            --privileged \
            --network host \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            -v ${{ github.workspace }}:/source:ro \
            -v ${{ env.HOST_WORKSPACE }}/poky:/host/poky:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-starry:/host/meta-starry:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-openembedded:/host/meta-openembedded:ro \
            -v ${{ env.HOST_WORKSPACE }}/StarryOS/arceos:/host/arceos:ro \
            -v ${{ env.HOST_WORKSPACE }}/StarryOS/local_crates:/host/local_crates:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/conf:/host/conf:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/sstate-cache:/host/sstate-cache:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/downloads:/host/downloads:ro \
            --tmpfs /build:exec,size=20G \
            -e HOST_PATH=${{ env.HOST_WORKSPACE }} \
            -e TRIGGER_REPO=${{ env.TRIGGER_REPO }} \
            -e TRIGGER_SHA=${{ env.TRIGGER_SHA }} \
            -e TRIGGER_REF=${{ env.TRIGGER_REF }} \
            -e http_proxy="http://${{ env.PROXY_HOST }}" \
            -e https_proxy="http://${{ env.PROXY_HOST }}" \
            -e HTTP_PROXY="http://${{ env.PROXY_HOST }}" \
            -e HTTPS_PROXY="http://${{ env.PROXY_HOST }}" \
            ${{ env.DOCKER_IMAGE }} \
            bash -c '
              set -e
              
              echo "=========================================="
              echo "       StarryOS CI Build and Test"
              echo "=========================================="
              echo ""
              
              # ==================== 环境信息 ====================
              echo "=== Environment Info ==="
              echo "User: $(whoami)"
              echo "Trigger Repo: ${TRIGGER_REPO:-StarryOS (direct)}"
              echo "Trigger SHA: ${TRIGGER_SHA:-N/A}"
              echo ""
              
              # ==================== 创建工作区 ====================
              echo "=== Setting up workspace ==="
              WORKSPACE=/build/workspace
              mkdir -p $WORKSPACE
              
              # 符号链接共享的 Yocto 组件（只读）
              ln -sfn /host/poky $WORKSPACE/poky
              ln -sfn /host/meta-starry $WORKSPACE/meta-starry
              ln -sfn /host/meta-openembedded $WORKSPACE/meta-openembedded
              
              echo "Linked shared components:"
              echo "  poky -> /host/poky"
              echo "  meta-starry -> /host/meta-starry"
              echo "  meta-openembedded -> /host/meta-openembedded"
              echo ""
              
              # ==================== 复制 StarryOS 代码 ====================
              echo "=== Copying StarryOS source code ==="
              
              # 复制 PR 代码作为 StarryOS 主目录
              mkdir -p $WORKSPACE/StarryOS
              cp -a /source/. $WORKSPACE/StarryOS/
              rm -rf $WORKSPACE/StarryOS/.git $WORKSPACE/StarryOS/target
              
              echo "PR code copied to $WORKSPACE/StarryOS"
              echo ""
              
              # 补齐子项目（来自宿主机 repo 工作区）
              echo "=== Copying sub-projects from host ==="
              
              if [ -d /host/arceos ]; then
                rm -rf $WORKSPACE/StarryOS/arceos
                cp -a /host/arceos $WORKSPACE/StarryOS/arceos
                echo "  arceos: copied"
              fi
              
              if [ -d /host/local_crates ]; then
                rm -rf $WORKSPACE/StarryOS/local_crates
                cp -a /host/local_crates $WORKSPACE/StarryOS/local_crates
                echo "  local_crates: copied"
              fi
              echo ""
              
              # ==================== 处理子仓库 PR 触发 ====================
              if [ -n "$TRIGGER_REPO" ] && [ -n "$TRIGGER_SHA" ]; then
                echo "=== Sub-repository PR detected ==="
                echo "Repo: $TRIGGER_REPO"
                echo "SHA: $TRIGGER_SHA"
                echo ""
                
                # 对于子仓库 PR，需要用 PR 代码替换对应目录
                # 这里 /source 包含的是子仓库的 PR 代码
                case "$TRIGGER_REPO" in
                  "arceos")
                    echo "Replacing arceos with PR code..."
                    rm -rf $WORKSPACE/StarryOS/arceos
                    cp -a /source/. $WORKSPACE/StarryOS/arceos/
                    rm -rf $WORKSPACE/StarryOS/arceos/.git
                    echo "Done: arceos replaced"
                    ;;
                    
                  "arm-gic")
                    echo "Replacing arm-gic with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/arm-gic
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/arm-gic/
                    rm -rf $WORKSPACE/StarryOS/local_crates/arm-gic/.git
                    echo "Done: arm-gic replaced"
                    ;;
                    
                  "axcpu")
                    echo "Replacing axcpu with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/axcpu
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/axcpu/
                    rm -rf $WORKSPACE/StarryOS/local_crates/axcpu/.git
                    echo "Done: axcpu replaced"
                    ;;
                    
                  "axdriver_crates")
                    echo "Replacing axdriver_crates with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/axdriver_crates
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/axdriver_crates/
                    rm -rf $WORKSPACE/StarryOS/local_crates/axdriver_crates/.git
                    echo "Done: axdriver_crates replaced"
                    ;;
                    
                  "axplat_crates")
                    echo "Replacing axplat_crates with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/axplat_crates
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/axplat_crates/
                    rm -rf $WORKSPACE/StarryOS/local_crates/axplat_crates/.git
                    echo "Done: axplat_crates replaced"
                    ;;
                    
                  "page_table_multiarch")
                    echo "Replacing page_table_multiarch with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/page_table_multiarch
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/page_table_multiarch/
                    rm -rf $WORKSPACE/StarryOS/local_crates/page_table_multiarch/.git
                    echo "Done: page_table_multiarch replaced"
                    ;;
                    
                  "kernel_guard")
                    echo "Replacing kernel_guard with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/kernel_guard
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/kernel_guard/
                    rm -rf $WORKSPACE/StarryOS/local_crates/kernel_guard/.git
                    echo "Done: kernel_guard replaced"
                    ;;
                    
                  "fdtree-rs")
                    echo "Replacing fdtree-rs with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/fdtree-rs
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/fdtree-rs/
                    rm -rf $WORKSPACE/StarryOS/local_crates/fdtree-rs/.git
                    echo "Done: fdtree-rs replaced"
                    ;;
                    
                  "axplat-aarch64-crosvm-virt")
                    echo "Replacing axplat-aarch64-crosvm-virt with PR code..."
                    rm -rf $WORKSPACE/StarryOS/local_crates/axplat-aarch64-crosvm-virt
                    cp -a /source/. $WORKSPACE/StarryOS/local_crates/axplat-aarch64-crosvm-virt/
                    rm -rf $WORKSPACE/StarryOS/local_crates/axplat-aarch64-crosvm-virt/.git
                    echo "Done: axplat-aarch64-crosvm-virt replaced"
                    ;;
                    
                  *)
                    echo "Unknown trigger repo: $TRIGGER_REPO (treating as StarryOS PR)"
                    ;;
                esac
                echo ""
              fi
              
              # ==================== 创建构建配置 ====================
              echo "=== Creating build configuration ==="
              mkdir -p $WORKSPACE/build/conf
              
              # 复制并修改 bblayers.conf
              cp /host/conf/bblayers.conf $WORKSPACE/build/conf/bblayers.conf
              sed -i "s|$HOST_PATH|$WORKSPACE|g" $WORKSPACE/build/conf/bblayers.conf
              
              # 复制 local.conf 并添加 EXTERNALSRC 配置
              cp /host/conf/local.conf $WORKSPACE/build/conf/local.conf
              
              # 添加 CI 专用配置
              {
                echo ""
                echo "# ==================== CI Configuration ===================="
                echo "# Auto-generated by GitHub Actions"
                echo ""
                echo "# 指定 StarryOS 源码路径（全局和 recipe 特定）"
                echo "EXTERNALSRC = \"$WORKSPACE/StarryOS\""
                echo "EXTERNALSRC_pn-starry = \"$WORKSPACE/StarryOS\""
                echo "EXTERNALSRC_BUILD_pn-starry = \"$WORKSPACE/StarryOS\""
                echo ""
                echo "# ==================== 缓存和镜像配置 ===================="
                echo "# 构建时写入临时目录（CI 结束后清理）"
                echo "SSTATE_DIR = \"/build/sstate-cache\""
                echo "DL_DIR = \"/build/downloads\""
                echo ""
                echo "# sstate mirror - 从 host 只读镜像读取已有缓存"
                echo "SSTATE_MIRRORS = \"file://.* file:///host/sstate-cache/PATH\""
                echo ""
                echo "# downloads mirror - 优先从 host 只读镜像获取源码包"
                echo "PREMIRRORS:prepend = \"file://.*/.* file:///host/downloads/PATH \\n\""
              } >> $WORKSPACE/build/conf/local.conf
              
              # 追加 starry recipe 的 vardepsexclude（修复 EXTERNALSRC basehash 问题）
              {
                echo ""
                echo "# ==================== 修复 EXTERNALSRC 元数据非确定性 ===================="
                echo "# 排除时间相关变量以稳定 basehash"
                echo "do_configure_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
                echo "do_compile_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
                echo "do_install_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
                echo "do_deploy_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
                echo "do_populate_sysroot_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
                echo "do_deploy_source_date_epoch_pn-starry[vardepsexclude] += \"DATE TIME DATETIME\""
              } >> $WORKSPACE/build/conf/local.conf
              
              echo "Configuration files created:"
              echo ""
              echo "=== bblayers.conf ==="
              cat $WORKSPACE/build/conf/bblayers.conf
              echo ""
              echo "=== local.conf (tail) ==="
              tail -20 $WORKSPACE/build/conf/local.conf
              echo ""
              
              # ==================== 构建镜像 ====================
              echo "=== Initializing Yocto environment ==="
              cd $WORKSPACE
              source poky/oe-init-build-env build
              
              echo ""
              echo "=== Building StarryOS kernel ==="
              bitbake starry
              
              echo ""
              echo "=== Building starry-ci-image ==="
              bitbake starry-ci-image
              
              echo ""
              echo "=== Build Complete ==="
              ls -la tmp-musl/deploy/images/aarch64-qemu-virt/ 2>/dev/null | head -15 || echo "Check deploy directory"
              echo ""
              
              # ==================== 运行测试 ====================
              echo "=== Running QEMU test ==="
              
              # 简单启动测试：验证内核能否启动并登录
              timeout 180 bash -c '\''
                runqemu starry-ci-image nographic slirp &
                QEMU_PID=$!
                
                # 等待 QEMU 启动
                sleep 90
                
                if ps -p $QEMU_PID > /dev/null; then
                  echo ""
                  echo "QEMU boot test PASSED - system started successfully"
                  kill $QEMU_PID 2>/dev/null || true
                  wait $QEMU_PID 2>/dev/null || true
                  exit 0
                else
                  echo ""
                  echo "QEMU boot test FAILED - system exited unexpectedly"
                  exit 1
                fi
              '\'' || {
                RESULT=$?
                if [ $RESULT -eq 124 ]; then
                  echo "QEMU test timed out (this might be OK if system is running slowly)"
                  # 尝试清理
                  pkill -f qemu || true
                  exit 0
                fi
                echo "QEMU test failed with exit code: $RESULT"
                exit $RESULT
              }
              
              echo ""
              echo "=========================================="
              echo "       CI Build and Test Complete"
              echo "=========================================="
            '

      # ==================== 清理 ====================
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          # tmpfs /build 会自动清理，无需手动删除
          
          # 清理可能残留的容器
          docker ps -aq --filter "ancestor=${{ env.DOCKER_IMAGE }}" | xargs -r docker rm -f 2>/dev/null || true
          
          echo ""
          echo "=== Host Disk Usage ==="
          df -h ${{ env.HOST_WORKSPACE }} | tail -1
          echo ""
          echo "Host cache sizes:"
          du -sh ${{ env.HOST_WORKSPACE }}/build/sstate-cache 2>/dev/null || echo "No sstate-cache"
          du -sh ${{ env.HOST_WORKSPACE }}/build/downloads 2>/dev/null || echo "No downloads"
