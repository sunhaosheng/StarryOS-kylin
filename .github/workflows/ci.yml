name: StarryOS CI (Yocto Image)

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  # 子仓库触发（arceos、arm-gic 等提 PR 时）
  repository_dispatch:
    types: [sub-repo-pr]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}-${{ github.event.client_payload.trigger_repo || 'starryos' }}
  cancel-in-progress: true

jobs:
  ci-test:
    runs-on: self-hosted
    timeout-minutes: 120
    
    env:
      # Host workspace 路径（管理员维护的基准环境）
      HOST_WORKSPACE: /home/yean/code/starryos-workspace
      # CI 隔离工作目录
      CI_WORKSPACE: /tmp/starryos-ci-${{ github.run_id }}
      # 代理设置
      PROXY_HOST: 10.41.113.211:7897
      # 触发信息（用于子仓库 PR）
      TRIGGER_REPO: ${{ github.event.client_payload.trigger_repo || 'StarryOS' }}
      TRIGGER_SHA: ${{ github.event.client_payload.trigger_sha || '' }}
      TRIGGER_REF: ${{ github.event.client_payload.trigger_ref || '' }}
      
    steps:
      # ==================== 代码准备（Docker 外） ====================
      - name: Prepare isolated workspace
        run: |
          echo "=== Create Isolated CI Workspace ==="
          mkdir -p ${{ env.CI_WORKSPACE }}/{code,build,results}
          
          echo "CI Workspace: ${{ env.CI_WORKSPACE }}"
          echo "Host Workspace: ${{ env.HOST_WORKSPACE }}"
          echo ""
          
      - name: Initialize repo in CI workspace
        run: |
          echo "=== Initialize Repo in CI Workspace ==="
          cd ${{ env.CI_WORKSPACE }}/code
          
          # 复制 host 的 repo 工具和 manifest（避免从 Google 服务器下载）
          mkdir -p .repo
          cp -r ${{ env.HOST_WORKSPACE }}/.repo/repo .repo/
          cp -r ${{ env.HOST_WORKSPACE }}/.repo/manifests .repo/
          cp -r ${{ env.HOST_WORKSPACE }}/.repo/manifests.git .repo/
          cp ${{ env.HOST_WORKSPACE }}/.repo/manifest.xml .repo/
          
          echo "✓ Repo tools and manifests copied from host"
          echo ""
          
          # 使用本地的 repo 初始化，不需要从网络下载
          # --reference 指向 host workspace，复用 git objects
          .repo/repo/repo init \
            -u ${{ env.HOST_WORKSPACE }}/.repo/manifests \
            -b main \
            --no-clone-bundle \
            --reference=${{ env.HOST_WORKSPACE }}
          
          echo "✓ Repo initialized with reference to host workspace"
          echo ""
          
      - name: Sync all sub-projects via repo
        run: |
          echo "=== Repo Sync ==="
          cd ${{ env.CI_WORKSPACE }}/code
          
          # 如果 StarryOS 目录存在且有冲突，先删除它（会被 PR 代码替换）
          if [ -d "StarryOS" ]; then
            echo "Removing existing StarryOS directory (will be replaced with PR code)"
            rm -rf StarryOS
          fi
          
          # 同步所有子项目到默认分支（StarryOS 会被跳过，因为目录不存在）
          repo sync -c --no-clone-bundle -j$(nproc)
          
          echo ""
          echo "✓ Sub-projects synced:"
          ls -la StarryOS/ 2>/dev/null | head -10 || echo "StarryOS will be created from PR code"
          echo ""
          
          # 显示 repo 状态
          echo "Repo status summary:"
          repo info | head -20
          
      - name: Checkout StarryOS to PR commit
        uses: actions/checkout@v4
        with:
          path: ${{ env.CI_WORKSPACE }}/code/StarryOS-pr
          submodules: false
          
      - name: Replace StarryOS with PR code
        run: |
          echo "=== Replace StarryOS with PR Code ==="
          cd ${{ env.CI_WORKSPACE }}/code
          
          # repo sync 创建的目录结构：
          #   StarryOS/arceos/          <- 子项目，需要保留
          #   StarryOS/local_crates/    <- 子项目，需要保留
          
          # 临时保存子项目
          echo "Preserving sub-projects..."
          mkdir -p StarryOS-subprojects
          if [ -d "StarryOS/arceos" ]; then
            mv StarryOS/arceos StarryOS-subprojects/
            echo "  - arceos preserved"
          fi
          if [ -d "StarryOS/local_crates" ]; then
            mv StarryOS/local_crates StarryOS-subprojects/
            echo "  - local_crates preserved"
          fi
          
          # 删除 StarryOS 主目录（现在是空的或只有 repo sync 的占位符）
          rm -rf StarryOS
          
          # 使用 PR 代码
          mv StarryOS-pr StarryOS
          
          # 恢复子项目
          echo "Restoring sub-projects to PR code..."
          if [ -d "StarryOS-subprojects/arceos" ]; then
            mv StarryOS-subprojects/arceos StarryOS/
            echo "  - arceos restored"
          fi
          if [ -d "StarryOS-subprojects/local_crates" ]; then
            mv StarryOS-subprojects/local_crates StarryOS/
            echo "  - local_crates restored"
          fi
          rm -rf StarryOS-subprojects
          
          # 显示最终结构
          cd StarryOS
          echo ""
          echo "PR Commit: $(git rev-parse HEAD)"
          echo "PR Branch: $(git branch --show-current 2>/dev/null || echo 'detached')"
          echo ""
          echo "Sub-projects:"
          ls -la | grep "^d" | grep -E "arceos|local_crates" || echo "  (none)"
          
      - name: Handle sub-repository PR (if triggered by sub-repo)
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "=== Sub-Repository PR Detected ==="
          echo "Trigger repo: ${{ env.TRIGGER_REPO }}"
          echo "Trigger SHA: ${{ env.TRIGGER_SHA }}"
          echo "Trigger ref: ${{ env.TRIGGER_REF }}"
          echo ""
          
          cd ${{ env.CI_WORKSPACE }}/code/StarryOS
          
          # 根据触发的仓库，替换对应的子项目
          case "${{ env.TRIGGER_REPO }}" in
            "arceos")
              echo "Replacing arceos with PR code..."
              if [ -d "arceos" ]; then
                cd arceos
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ arceos updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " arceos directory not found"
              fi
              ;;
              
            "arm-gic")
              echo "Replacing arm-gic with PR code..."
              if [ -d "local_crates/arm-gic" ]; then
                cd local_crates/arm-gic
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ arm-gic updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " arm-gic directory not found"
              fi
              ;;
              
            "axcpu")
              echo "Replacing axcpu with PR code..."
              if [ -d "local_crates/axcpu" ]; then
                cd local_crates/axcpu
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ axcpu updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " axcpu directory not found"
              fi
              ;;
              
            "axdriver_crates")
              echo "Replacing axdriver_crates with PR code..."
              if [ -d "local_crates/axdriver_crates" ]; then
                cd local_crates/axdriver_crates
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ axdriver_crates updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " axdriver_crates directory not found"
              fi
              ;;
              
            "axplat_crates")
              echo "Replacing axplat_crates with PR code..."
              if [ -d "local_crates/axplat_crates" ]; then
                cd local_crates/axplat_crates
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ axplat_crates updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " axplat_crates directory not found"
              fi
              ;;
              
            "page_table_multiarch")
              echo "Replacing page_table_multiarch with PR code..."
              if [ -d "local_crates/page_table_multiarch" ]; then
                cd local_crates/page_table_multiarch
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ page_table_multiarch updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " page_table_multiarch directory not found"
              fi
              ;;
              
            "kernel_guard")
              echo "Replacing kernel_guard with PR code..."
              if [ -d "local_crates/kernel_guard" ]; then
                cd local_crates/kernel_guard
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ kernel_guard updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " kernel_guard directory not found"
              fi
              ;;
              
            "fdtree-rs")
              echo "Replacing fdtree-rs with PR code..."
              if [ -d "local_crates/fdtree-rs" ]; then
                cd local_crates/fdtree-rs
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ fdtree-rs updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " fdtree-rs directory not found"
              fi
              ;;
              
            "axplat-aarch64-crosvm-virt")
              echo "Replacing axplat-aarch64-crosvm-virt with PR code..."
              if [ -d "local_crates/axplat-aarch64-crosvm-virt" ]; then
                cd local_crates/axplat-aarch64-crosvm-virt
                git fetch origin ${{ env.TRIGGER_SHA }}
                git checkout ${{ env.TRIGGER_SHA }}
                echo "✓ axplat-aarch64-crosvm-virt updated to PR commit: $(git rev-parse --short HEAD)"
              else
                echo " axplat-aarch64-crosvm-virt directory not found"
              fi
              ;;
              
            *)
              echo " Unknown trigger repo: ${{ env.TRIGGER_REPO }}"
              ;;
          esac
          
      - name: Verify code structure
        run: |
          echo "=== Verify Code Structure ==="
          cd ${{ env.CI_WORKSPACE }}/code
          
          echo "Top-level directories:"
          ls -la | grep "^d" | awk '{print $NF}'
          echo ""
          
          echo "StarryOS contents:"
          ls -la StarryOS/ | head -15
          echo ""
          
          # 检查关键组件
          for dir in "StarryOS/arceos" "StarryOS/local_crates" "poky" "meta-starry" "meta-openembedded"; do
            if [ -d "$dir" ]; then
              echo "✓ $dir"
            else
              echo "✗ $dir (missing)"
            fi
          done
          
      # ==================== 准备 CI 配置 ====================
      - name: Prepare CI build configuration
        run: |
          echo "=== Prepare CI Build Configuration ==="
          mkdir -p ${{ env.CI_WORKSPACE }}/build/conf
          
          # 创建 CI 专用 local.conf
          cat > ${{ env.CI_WORKSPACE }}/build/conf/local.conf << 'EOF'
          # StarryOS CI Build Configuration
          # Generated by GitHub Actions
          MACHINE ?= "aarch64-qemu-virt"
          DISTRO = "starryos"
          BB_NUMBER_THREADS = "32"
          PARALLEL_MAKE = "-j 32"
          # 下载目录 - 只读挂载到 host
          DL_DIR = "/host-downloads"
          # 本地 sstate - 临时目录，CI 结束后丢弃
          SSTATE_DIR = "${TOPDIR}/sstate-cache"
          # sstate mirror - 只读，从 host 基准目录读取
          # CI 不会写入 host 的 sstate-cache
          SSTATE_MIRRORS = "file://.* file:///host-sstate/PATH"
          PATCHRESOLVE = "noop"
          USER_CLASSES ?= "buildstats"
          BB_DISKMON_DIRS ??= "\
              STOPTASKS,${TMPDIR},1G,100K \
              STOPTASKS,${DL_DIR},1G,100K \
              STOPTASKS,${SSTATE_DIR},1G,100K \
              STOPTASKS,/tmp,100M,100K \
              HALT,${TMPDIR},100M,1K \
              HALT,${DL_DIR},100M,1K \
              HALT,${SSTATE_DIR},100M,1K \
              HALT,/tmp,10M,1K"
          CONF_VERSION = "3"
          TEST_SUITES = "ci unixbench stress"
          EOF
          
          # 创建 bblayers.conf
          cat > ${{ env.CI_WORKSPACE }}/build/conf/bblayers.conf << 'EOF'
          # StarryOS CI Layer Configuration
          
          POKY_BBLAYERS_CONF_VERSION = "2"
          
          BBPATH = "${TOPDIR}"
          BBFILES ?= ""
          
          BBLAYERS ?= " \
            /code/poky/meta \
            /code/poky/meta-poky \
            /code/meta-openembedded/meta-oe \
            /code/meta-openembedded/meta-python \
            /code/meta-starry \
          "
          EOF
          
          echo "CI configuration created:"
          echo "- local.conf"
          echo "- bblayers.conf"
          
      # ==================== Docker 构建和测试 ====================
      - name: Build and test in Docker
        id: docker_build_test
        continue-on-error: true
        run: |
          echo "=== Start Docker Build and Test ==="
          
          docker run --rm --privileged \
            -v ${{ env.CI_WORKSPACE }}/code:/code:ro \
            -v ${{ env.CI_WORKSPACE }}/build:/build:rw \
            -v ${{ env.CI_WORKSPACE }}/results:/results:rw \
            -v ${{ env.HOST_WORKSPACE }}/build/sstate-cache:/host-sstate:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/downloads:/host-downloads:ro \
            -e http_proxy="http://${{ env.PROXY_HOST }}" \
            -e https_proxy="http://${{ env.PROXY_HOST }}" \
            -e HTTP_PROXY="http://${{ env.PROXY_HOST }}" \
            -e HTTPS_PROXY="http://${{ env.PROXY_HOST }}" \
            --workdir=/build \
            crops/poky:ubuntu-22.04 \
            bash -c '
              set -e
              
              echo "=== Environment Info ==="
              echo "User: $(whoami)"
              echo "Working directory: $(pwd)"
              echo ""
              
              # 安装必要工具
              echo "=== Install Required Tools ==="
              sudo apt-get update -qq
              sudo apt-get install -y -qq expect
              echo ""
              
              # 验证挂载
              echo "=== Verify Mounts ==="
              echo "Code directory:"
              ls -la /code/ | head -10
              echo ""
              echo "Host sstate-cache:"
              ls /host-sstate/ 2>/dev/null | head -5 || echo "(empty or not mounted)"
              echo "Host downloads:"
              ls /host-downloads/ 2>/dev/null | head -5 || echo "(empty or not mounted)"
              echo ""
              
              # 初始化构建环境
              echo "=== Initialize Build Environment ==="
              source /code/poky/oe-init-build-env /build
              
              # 显示配置
              echo ""
              echo "=== Build Configuration ==="
              echo "MACHINE: $(bitbake -e | grep "^MACHINE=" | head -1)"
              echo "SSTATE_MIRRORS: $(bitbake -e | grep "^SSTATE_MIRRORS=" | head -1 | cut -c1-80)..."
              echo ""
              
              # 构建 CI 镜像
              echo "=== Build starry-ci-image ==="
              bitbake starry-ci-image
              
              echo ""
              echo "=== Build Complete ==="
              ls -la tmp-musl/deploy/images/aarch64-qemu-virt/ 2>/dev/null | head -10 || echo "Check deploy directory"
              echo ""
              
              # 复制测试脚本到结果目录
              echo "=== Prepare QEMU Test Script ==="
              cp /code/StarryOS/.github/scripts/run-qemu-ci.exp /results/
              chmod +x /results/run-qemu-ci.exp
              
              # 运行测试
              echo "=== Run CI Tests in QEMU ==="
              cd /results
              ./run-qemu-ci.exp /build /results/qemu-output.log || echo "Test script exited with code: $?"
              
              echo ""
              echo "=== Test Execution Complete ==="
            '
          
      # ==================== 结果处理 ====================
      - name: Parse test results
        id: parse_results
        if: always()
        run: |
          LOG_FILE="${{ env.CI_WORKSPACE }}/results/qemu-output.log"
          
          echo "=== Test Output ==="
          if [ -f "$LOG_FILE" ]; then
            cat "$LOG_FILE"
            echo ""
            
            echo "=== Test Summary ==="
            if grep -q "Test Results Summary" "$LOG_FILE"; then
              grep -A 10 "Test Results Summary" "$LOG_FILE"
              
              # 检查是否有失败
              if grep -q "Failed: 0" "$LOG_FILE"; then
                echo ""
                echo "✅ All tests passed!"
                echo "test_result=success" >> $GITHUB_OUTPUT
              else
                echo ""
                echo "❌ Some tests failed"
                echo "test_result=failure" >> $GITHUB_OUTPUT
                
                # 显示失败的测试
                echo ""
                echo "=== Failed Tests ==="
                grep -B 2 -A 2 "✗\|FAIL\|Error" "$LOG_FILE" | head -30 || true
              fi
            else
              echo "⚠️ Could not find test results in output"
              echo "test_result=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ No log file found at $LOG_FILE"
            echo "test_result=error" >> $GITHUB_OUTPUT
            
            # 列出 results 目录内容
            echo ""
            echo "Results directory contents:"
            ls -la ${{ env.CI_WORKSPACE }}/results/ 2>/dev/null || echo "(directory not found)"
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-logs-${{ github.run_id }}
          path: ${{ env.CI_WORKSPACE }}/results/
          if-no-files-found: warn
          
      # ==================== 清理 ====================
      - name: Cleanup isolated workspace
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          # 删除整个 CI 工作目录
          rm -rf ${{ env.CI_WORKSPACE }}
          
          echo "Isolated workspace cleaned up"
          echo ""
          
          # 显示 host 磁盘使用情况
          echo "=== Host Disk Usage ==="
          df -h ${{ env.HOST_WORKSPACE }} | tail -1
          echo ""
          echo "Host cache sizes:"
          du -sh ${{ env.HOST_WORKSPACE }}/build/sstate-cache 2>/dev/null || echo "No sstate-cache"
          du -sh ${{ env.HOST_WORKSPACE }}/build/downloads 2>/dev/null || echo "No downloads"
          
      - name: Fail job if tests failed
        if: steps.docker_build_test.outcome != 'success'
        run: |
          echo "❌ Build or tests did not complete successfully"
          exit 1
